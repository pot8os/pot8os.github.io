---
title: RxJava2からRxJava3に移行
date: "2021-02-10T00:00:00.000Z"
---

というのを目論んでいたのだけど、[Realmが移行する気なかったりする](https://github.com/realm/realm-java/issues/6871)ので完璧にRxJava2を消し去ることは出来ませんでした。
`import`の置換は特に造作もないけど、テストが結構失敗するようになってしまってその解決に時間がかかってしまった。結論としては何のことはなく、RxJava2をまだ何点か併用する必要があるので、Rxを同期実行させるTestRuleにもその旨両方記載する必要があったのでした。実装例としてはこんな感じ。

```kotlin
class ImmediateSchedulersRule: TestRule {
  @Override
  public fun apply(base: Statement, description: Description) {
    return new Statement() {
      @Override
      public fun evaluate() {
        // こっちはRxJava3
        RxJavaPlugins.setIoSchedulerHandler { Schedulers.trampoline() }
        RxJavaPlugins.setComputationSchedulerHandler { Schedulers.trampoline() }
        RxJavaPlugins.setNewThreadSchedulerHandler { Schedulers.trampoline() }
        // RxJava2が生きてる場合はこちらも
        io.reactivex.plugins.RxJavaPlugins.setIoSchedulerHandler { io.reactivex.schedulers.Schedulers.Schedulers.trampoline() }
        io.reactivex.plugins.RxJavaPlugins.setComputationSchedulerHandler { io.reactivex.schedulers.Schedulers.Schedulers.trampoline() }
        io.reactivex.plugins.RxJavaPlugins.setNewThreadSchedulerHandler { io.reactivex.schedulers.Schedulers.Schedulers.trampoline() }
        try {
          base.evaluate()
        } finally {
          RxJavaPlugins.reset()
          // こちらも忘れずに
          io.reactivex.plugins.RxJavaPlugins.reset()
        }
      }
    }
  }
}
```

### 結論

Realm早く辞めたい
